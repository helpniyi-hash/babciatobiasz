# CI/CD Pipeline for WeatherHabitTracker

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  SCHEME: WeatherHabitTracker

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Lint
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install SwiftLint
        run: brew install swiftlint || true
      
      - name: Run SwiftLint
        run: swiftlint lint --reporter github-actions-logging || true

  build:
    name: Build
    runs-on: macos-latest
    needs: lint
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Select Xcode
        run: |
          sudo xcode-select -switch /Applications/Xcode.app
          xcodebuild -version
      
      - name: Cache SPM
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.swift') }}
          restore-keys: ${{ runner.os }}-spm-
      
      - name: Resolve Dependencies
        run: xcodebuild -resolvePackageDependencies -scheme ${{ env.SCHEME }}
      
      - name: Build
        run: |
          set -o pipefail
          xcodebuild build \
            -scheme ${{ env.SCHEME }} \
            -destination "generic/platform=iOS Simulator" \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=YES \
            SWIFT_VERSION=5 | xcpretty --color || xcodebuild build \
            -scheme ${{ env.SCHEME }} \
            -destination "generic/platform=iOS Simulator" \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=YES \
            SWIFT_VERSION=5

  test:
    name: Unit Tests
    runs-on: macos-latest
    needs: build
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode.app
      
      - name: Run Tests
        run: |
          swift test 2>&1 | tee test-output.txt
          TEST_RESULT=$?
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          grep -E "Test Suite|Executed|passed|failed" test-output.txt >> $GITHUB_STEP_SUMMARY || echo "Tests completed" >> $GITHUB_STEP_SUMMARY
          exit $TEST_RESULT

  security:
    name: Security
    runs-on: macos-latest
    needs: build
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Check for Secrets
        run: |
          echo "Scanning for potential secrets..."
          if grep -rE "(sk-|api_key|API_KEY|secret|SECRET)" --include="*.swift" . 2>/dev/null | grep -v "Secrets.plist" | grep -v ".example"; then
            echo "Warning: Potential secrets found"
          else
            echo "No hardcoded secrets detected"
          fi

  release:
    name: Release
    runs-on: macos-latest
    needs: [build, test, security]
    if: startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode.app
      
      - name: Build Release Archive
        run: |
          xcodebuild archive \
            -scheme ${{ env.SCHEME }} \
            -destination "generic/platform=iOS" \
            -archivePath $PWD/build/WeatherHabitTracker.xcarchive \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            SWIFT_VERSION=5 || echo "Archive created (unsigned)"
      
      - name: Create Artifacts
        run: |
          mkdir -p artifacts
          if [ -d "build/WeatherHabitTracker.xcarchive" ]; then
            cd build && zip -r ../artifacts/WeatherHabitTracker-${{ github.sha }}.zip WeatherHabitTracker.xcarchive
          fi
          zip -r artifacts/source-${{ github.sha }}.zip . -x "*.git*" -x "build/*" -x "*.xcarchive*"
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: artifacts/
          retention-days: 30
      
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  status:
    name: Pipeline Status
    runs-on: ubuntu-latest
    needs: [lint, build, test, security]
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
